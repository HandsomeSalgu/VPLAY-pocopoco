<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPLAY - Stock Videos</title>
    <link href="/css/board/videoTemplates/list.css" rel="stylesheet">
    <link href="/css/topbar.css" rel="stylesheet" type="text/css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>
	<div th:replace="~{views/common/topbar :: topbar}"></div>
	
    <div class="main-content">
        <aside class="sidebar">
            <div class="category-title">Categories</div>
            <ul class="category-list">
            	<th:block th:each="vc : ${cCategory}">
            	<li>
            	<input type="checkbox" class="category-checkbox" th:value="${vc.categoryName}">
            	<a>[[${vc.categoryName}]]</a>
            	</li>
            	</th:block>
            </ul>
        </aside>

        <main class="content">

            <div class="search-bar">
                <input type="text" placeholder="Search">
            </div>
            <div class="video-grid">
                <div class="video-card" th:each="vl: ${cList}" th:if="${vl.menuNo == 1 || vl.menuNo == 5 || vl.menuNo == 2 || vl.menuNo == 4 || vl.menuNo == 6 || vlmenuNo == 7}">
                    <div class="video-thumbnail">
                    	<th:block th:if="${vl.menuNo == 1 || vl.menuNo == 5}">
	                    <video id="video-preview" muted loop>
		                	<source type="video/mp4">
		                </video>
		                </th:block>
		                <th:block th:if="${vl.menuNo == 4 || vl.menuNo == 6 || vl.menuNo == 7}">
		               		 <img id="video-preview">
		                </th:block>
                    </div>
                    <div class="video-info">
                    	<input type="hidden" th:value="${vl.contentNo}"/>
                    	<input type="hidden" th:value="${vl.menuNo}">
                        <h3>[[${vl.contentTitle}]]</h3>
                        <p>[[${vl.userNickName}]]</p>
                    </div>
                </div>
            </div>
			<div class="music-card" th:each="vl : ${cList}">
			  <th:block th:if="${vl.menuNo == 3}">
			    <div class="audio-card">
			      <div class="audio-left">
			        <button class="play-btn" th:attr="data-id=${vl.contentNo}">‚ñ∂</button>
			      </div>
			      <div class="audio-middle" th:attr="id='waveform-' + ${vl.contentNo}"></div>
			      <div class="audio-right">
			        <span class="duration">0:00</span>
			        <span class="icon download">üíæ</span>
			        <span class="icon heart">‚ù§Ô∏è</span>
			      </div>
			      <input type="hidden" th:value="${vl.contentNo}" />
			      <input type="hidden" th:value="${vl.menuNo}" />
			    </div>
			  </th:block>
			</div>
        </main>
    </div>
    <script th:inline="javascript">
    const divs = document.querySelector('.video-grid');
    const waveMap = {};
    [...divs.children].map((video, index, array) =>{
		video.addEventListener('click', function(){
			const contentNo = video.children[1].children[0].value;
			const menuNo = video.children[1].children[1].value;
			let menuName = "";
			console.log(contentNo);
			console.log(menuNo);
			switch(menuNo){
			case "1": menuName = "video-templates"; break;
			case "2": menuName = "music"; break;
			case "3": menuName = "sound-effect"; break;
			case "4": menuName = "graphic-templates"; break;
			case "5": menuName = "stock-video"; break;
			case "6": menuName = "photo"; break;
			case "7": menuName = "font";
			}
			
			console.log(menuName);
			
			location.href = "/board/" + menuName + "/" + contentNo;
		})
	})
	
	const menuNameURL = (window.location.pathname).split("/")[2];
    console.log(menuNameURL);
    
	window.onload=()=>{
		thumbnailPlay();
//     	console.log(divs);
    	
    	const checkbox = document.querySelectorAll(".category-checkbox");
    	/*<![CDATA[*/
    	const content = /*[[${cList}]]*/1;
    	/*]]>*/
    	console.log(content);
    	
    	let lastSegment = window.location.pathname.split("/").pop();
    	let lastSegment2 = lastSegment.split("-").pop();
    	
    	console.log("lastSegment2 : " + lastSegment2);
		
    	if(lastSegment2 != "list"){
			[...checkbox].map((video, index, array) =>{
				video.checked = false;
				for(let i =0; i<content.length ; i++){
					if(content[i].categoryName == video.value){
						video.checked = true;
					}
				}
			})
    	}
    	
    	const categoryList = document.querySelector('.category-list');
//     	console.log(categoryList);
    	const checkboxArr = [];
    	[...categoryList.children].map((category, index, array) =>{
    		const checkbox = category.children[0];
    		checkbox.addEventListener('click', (event)=>{
    			
    			for(const c of categoryList.children){
    				if(c.children[0].checked){
    					checkboxArr.push(c.children[0].value);
    				}
    			}
    			let newUrl = null;
    			let checkboxValue = "";
    			
    			if(checkboxArr.length==0){
    				checkboxValue = "empty";
    				newUrl = `/board/${menuNameURL}`;
    			}else{
    				let str = checkboxArr.join("+");
					
					checkboxValue = str.replaceAll(" ", "-");
	    			newUrl = `/board/${menuNameURL}/${checkboxValue}`;
    			}
    			
    			checkboxArr.length = 0;
    		
				updatePage(checkboxValue, 1, null);
				
    		})
    	})
    	//Í≤ÄÏÉâ
		const input = document.getElementsByTagName("input")[5];
    	console.log(input);
		input.addEventListener('keyup', (event)=>{
			event.preventDefault();
			if(event.key == 'Enter'){
				const search = input.value;
				
				lastSegment = window.location.pathname.split("/").pop();
				lastSegment2 = lastSegment.split("-").pop();
				
				console.log("ÏóîÌÑ∞ ÎàÑÎ•¥Í≥† ÎÇòÏÑú : " + search);
				console.log("ÏóîÌÑ∞ ÎàÑÎ•¥Í≥† ÎÇòÏÑú : " + lastSegment2);
				updatePage(lastSegment2, 0 ,search);
			}
		});
    }
    
	window.addEventListener("popstate", (event) =>{
	    	if(event.state){
	    		console.log("Îí§Î°ú Í∞ÄÍ∏∞ Í∞êÏßÄ, Ïù¥Ï†Ñ ÏÉÅÌÉú:", event);
// 				console.log(event.state.data);
	    		
	    		let check = event.state.checkboxValue;
	    		console.log(check);
	    		
	    		updatePage(check, 0, null);
	    		
	    		checkboxValue = check.replaceAll("-", " ");
	    		
// 				console.log(checkboxValue);
				
				const cArr = checkboxValue.split("+");
				
				const checkbox = document.querySelectorAll(".category-checkbox");
				console.log(checkbox);
				
				[...checkbox].map((video, index, array) =>{
					video.checked = false;
					for(let i =0; i<cArr.length ; i++){
						if(cArr[i] == video.value){
							video.checked = true;
						}
					}
				})
				
	    	}
	    });
    
    function updatePage(checkboxValue, flag, search) {
    	console.log("updatePageÏóê Îì§Ïñ¥Ïò¥ : " + checkboxValue);
        // Ïó¨Í∏∞Ïóê Ïã§Ï†ú ÌéòÏù¥ÏßÄÎ•º Í∞±Ïã†ÌïòÎäî Î°úÏßÅÏùÑ ÏûëÏÑ± (AJAX ÏöîÏ≤≠ Í∞ÄÎä•)
        
        let url = "";
        
        if(search != null){
        	if(checkboxValue != "list"){
        		url = `/board/${menuNameURL}/${checkboxValue}/${search}`;
        	}else{
        		url = `/board/${menuNameURL}/${search}`;
        	}
        }else if(checkboxValue != "empty"){
        	url = `/board/${menuNameURL}/${checkboxValue}`;
        }else{
        	url = `/board/${menuNameURL}`;
        }
        console.log("Î≥ÄÍ≤Ω url : " +url);
        
        fetch(url, {
				method : 'post',
				headers : {'content-type' : 'application/json; charset=UTF-8'}
			})
			.then(response => response.json())
			.then(data =>{
				if(data.length == 0){
					divs.innerHTML = "Ìï¥Îãπ Í∏ÄÏù¥ ÏóÜÏäµÎãàÎã§";
				}else{
					divs.innerHTML = '';
			    	for(const i of data){
			    		console.log("Ïù¥Í±∞Î≥¥Îäî Ï§ë :" + i.menuNo);
						const div1 = document.createElement("div");
						div1.className = "video-card";
						
						const div2 = document.createElement("div");
						div2.className = "video-thumbnail";
						
						if(i.menuNo == 1 || i.menuNo == 5){
							const video = document.createElement("video");
							video.id = "video-preview";
							video.muted = true;
							video.loop = true;
							
							const source = document.createElement("source");
							source.type = "video/mp4";
							
							video.appendChild(source);
							div2.appendChild(video);
						}else if(i.menuNo == 4 || i.menuNo == 6 || i.menuNo == 7 || i.menuNo == 2){
							const img = document.createElement("img");
							img.id="video-preview";
							
							div2.appendChild(img);
						}
						
						
						const div3 = document.createElement("div");
						div3.className = "video-info";
						
						const input = document.createElement("input");
						input.setAttribute("type", "hidden");
						input.setAttribute("value", i.contentNo);
						
						const input2 = document.createElement("input");
						input2.setAttribute("type", "hidden");
						input2.setAttribute("value", i.menuNo);
						
						const h3 = document.createElement("h3");
						h3.innerText = i.contentTitle;
						
						const p = document.createElement("p");
						p.innerText = i.userNickName;
						
						div1.appendChild(div2);
						div1.appendChild(div3);
						
						div3.appendChild(input);
						div3.appendChild(input2);
						div3.appendChild(h3);
						div3.appendChild(p);
						
						divs.appendChild(div1);
						
						div1.addEventListener('click', function(){
							  const contentNo = div1.querySelector('input[type=hidden]').value;
							  console.log(contentNo);
							  location.href = "/board/" + menuNameURL + "/" + contentNo;
						});
						
						
					}
			    	
			    	thumbnailPlay();
				}
				
				if(flag == 1){
					window.history.pushState({ data, checkboxValue }, "", url);
				}

			})
    }
    
    function thumbnailPlay() {
        const thumbnailList = document.querySelectorAll('.video-thumbnail, .audio-middle'); // Îëò Îã§ Ïû°ÏïÑÏ§å
        console.log("Ïç∏ÎÑ§Ïùº Î°úÎìú");

        [...thumbnailList].forEach((thumbnail) => {
            let contentNo, menuNo;

            if (thumbnail.classList.contains("video-thumbnail")) {
                const infoBox = thumbnail.parentElement.querySelector('.video-info');
                contentNo = infoBox.children[0].value;
                menuNo = infoBox.children[1].value;
            }

            else if (thumbnail.classList.contains("audio-middle")) {
                const audioCard = thumbnail.closest(".audio-card");
                const inputs = audioCard.querySelectorAll("input[type='hidden']");
                contentNo = inputs[0]?.value;
                menuNo = inputs[1]?.value;
            }

            if (!contentNo || !menuNo) {
                console.warn("ÌïÑÏöîÌïú Ï†ïÎ≥¥ ÎàÑÎùΩ, Ï≤òÎ¶¨ ÏÉùÎûµ");
                return;
            }

            fetch("/board/select-thumbnail/" + contentNo, {
                method: "get",
                headers: { 'content-type': 'application/json; charset=UTF-8' }
            })
            .then(response => response.json())
            .then(data => {
                if (menuNo == 1 || menuNo == 5) {
                    const video = thumbnail.children[0];
                    const source = video?.children[0];
                    if (source) {
                        source.src = data.thumbnail;
                        video.appendChild(source);
                        thumbnail.appendChild(video);
                        video.addEventListener('mouseenter', () => video.play());
                        video.addEventListener('mouseleave', () => {
                            video.pause();
                            video.currentTime = 0;
                        });
                    }
                } else if(menuNo == 3){
                    const waveformId = "#waveform-" + contentNo;
                    const wavesurfer = WaveSurfer.create({
                        container: waveformId,
                        waveColor: 'violet',
                        progressColor: 'purple',
                        height: 64,
                        responsive: true
                    });

                    wavesurfer.load(data.file);
                    waveMap[contentNo] = wavesurfer;
                    wavesurfer.on('ready', () => {
                        const totalSec = Math.floor(wavesurfer.getDuration());
                        durationSpan.innerText = `0:00 / ${formatTime(totalSec)}`;
                    });

                    wavesurfer.on('audioprocess', () => {
                        const currentTime = wavesurfer.getCurrentTime();
                        const totalTime = wavesurfer.getDuration();
                        durationSpan.innerText = `${formatTime(currentTime)} / ${formatTime(totalTime)}`;
                    });
                    
                    wavesurfer.on('seek', () => {
                        if (!wavesurfer.isPlaying()) {
                            wavesurfer.play();
                        }
                    });

                    wavesurfer.on('finish', () => {
                        durationSpan.innerText = `0:00 / ${formatTime(wavesurfer.getDuration())}`;
                        const playBtn = document.querySelector(`.play-btn[data-id='${contentNo}']`);
                        if (playBtn) playBtn.innerText = '‚ñ∂';
                    });

                    const durationSpan = document.querySelector(`#waveform-${contentNo}`)
                                                .closest('.audio-card')
                                                .querySelector('.duration');

                    wavesurfer.on('ready', () => {
                        const totalSec = Math.floor(wavesurfer.getDuration());
                        durationSpan.innerText = formatTime(totalSec);
                    });

                    const playBtn = document.querySelector(`.play-btn[data-id='${contentNo}']`);
                    playBtn.addEventListener('click', () => {
                        wavesurfer.playPause();
                        if (wavesurfer.isPlaying()) {
                            playBtn.innerText = '‚è∏';
                        } else {
                            playBtn.innerText = '‚ñ∂';
                        }
                    });
                } else {
                    const img = thumbnail.children[0];
                    if (img) img.src = data.thumbnail;
                }
            });
        });
        
        
        
        
    }
    
    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }
	

    
</script>
</body>
</html>